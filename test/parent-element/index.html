<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <script src="/leader-line.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f0f0f0;
        overflow: hidden;
        margin: 0;
      }

      #container {
        position: absolute;
        top: 50px;
        left: 50px;
        width: 600px;
        height: 400px;
        background-color: #ffffff;
        border: 1px solid #bdc3c7;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: auto;
      }

      .drag-handle {
        position: sticky; /* Keeps the handle visible when scrolling */
        top: 0;
        left: 0;
        z-index: 20; /* Ensures handle is on top of other content */
        width: 100%;
        height: 30px;
        background-color: #34495e;
        cursor: grab;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        user-select: none;
      }

      .resize-handle {
        position: absolute;
        width: 15px;
        height: 15px;
        right: 0;
        bottom: 0;
        cursor: nwse-resize;
        z-index: 20;
      }

      .draggable {
        position: absolute;
        z-index: 10;
        width: 120px;
        height: 60px;
        background-color: #3498db;
        color: white;
        border: 2px solid #2980b9;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: move;
        user-select: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #start-element {
        top: 100px;
        left: 100px;
        background-color: #e74c3c;
        border-color: #c0392b;
      }

      #end-element {
        top: 450px;
        left: 550px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="drag-handle">Drag Container</div>
      <div id="start-element" class="draggable">Start</div>
      <div id="end-element" class="draggable">End</div>
      <div class="resize-handle"></div>
    </div>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("container");
        const startEl = document.getElementById("start-element");
        const endEl = document.getElementById("end-element");
        const dragHandle = container.querySelector(".drag-handle");
        const resizeHandle = container.querySelector(".resize-handle");

        const line = new LeaderLine(startEl, endEl, {
          color: "rgba(52, 73, 94, 0.8)",
          size: 6,
          path: "fluid",
          endPlug: "arrow2",
          dash: { animation: true },
          parentElement: document.querySelector("#container"),
          stackingContextElement: document.querySelector("#container"),
        });

        // --- Event Listeners for Line Updates ---
        container.addEventListener("scroll", () => {
          line.position();
        });

        // --- Generic Dragging/Resizing Logic ---

        // Drags an element across the entire viewport (used for the container)
        function makeViewportDraggable(element, handle) {
          let isMouseDown = false;
          let offsetX, offsetY;

          handle.addEventListener("mousedown", (e) => {
            isMouseDown = true;
            offsetX = e.clientX - element.getBoundingClientRect().left;
            offsetY = e.clientY - element.getBoundingClientRect().top;
            handle.style.cursor = "grabbing";
            e.preventDefault();
          });

          document.addEventListener("mousemove", (e) => {
            if (!isMouseDown) return;
            e.preventDefault();
            element.style.left = `${e.clientX - offsetX}px`;
            element.style.top = `${e.clientY - offsetY}px`;
            line.position();
          });

          document.addEventListener("mouseup", () => {
            isMouseDown = false;
            handle.style.cursor = "grab";
          });
        }

        // Drags an element *relative to its parent container* (used for start/end items)
        function makeItemDraggable(element, parent) {
          let isMouseDown = false;
          let offsetX, offsetY;

          element.addEventListener("mousedown", (e) => {
            isMouseDown = true;
            // Offset of mouse from the element's own top-left
            offsetX = e.offsetX;
            offsetY = e.offsetY;
            e.stopPropagation(); // Prevents container drag from firing
          });

          document.addEventListener("mousemove", (e) => {
            if (!isMouseDown) return;

            // Get parent's position
            const parentRect = parent.getBoundingClientRect();

            // Calculate the new left and top relative to the parent
            // 1. Mouse position in viewport (e.clientX)
            // 2. Subtract parent's offset from viewport (parentRect.left)
            // 3. Add parent's scroll position (parent.scrollLeft)
            // 4. Subtract the initial mouse offset within the element (offsetX)
            const newLeft =
              e.clientX - parentRect.left + parent.scrollLeft - offsetX;
            const newTop =
              e.clientY - parentRect.top + parent.scrollTop - offsetY;

            element.style.left = `${newLeft}px`;
            element.style.top = `${newTop}px`;
            line.position();
          });

          document.addEventListener("mouseup", () => {
            isMouseDown = false;
          });
        }

        function makeResizable(element, handle) {
          let isResizing = false;
          let startX, startY, startWidth, startHeight;

          handle.addEventListener("mousedown", (e) => {
            isResizing = true;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = element.offsetWidth;
            startHeight = element.offsetHeight;
            e.preventDefault();
          });

          document.addEventListener("mousemove", (e) => {
            if (!isResizing) return;
            element.style.width = startWidth + e.clientX - startX + "px";
            element.style.height = startHeight + e.clientY - startY + "px";
            line.position();
          });

          document.addEventListener("mouseup", () => {
            isResizing = false;
          });
        }

        // --- Applying the Logic ---
        makeViewportDraggable(container, dragHandle);
        makeResizable(container, resizeHandle);
        makeItemDraggable(startEl, container);
        makeItemDraggable(endEl, container);
      });
    </script>
  </body>
</html>
